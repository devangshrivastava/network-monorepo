<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="./styles/style.css" />
  <script src="https://cdn.jsdelivr.net/gh/papnkukn/qrcode-svg/dist/qrcode.min.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <link rel="icon" href="/favicon.ico">
</head>

<%- include('../partials/google_analytics.ejs') %>

  <body class="antialiased bg-base-100">
    <script type="module">
      import { account, getContactForRelate, addConnection, portOldContacts, addContact, getContacts, getContactByUID, editContact, deleteContact, filterContacts,
        getProfile, updateProfile, signout, generateRecoveryKit, importContacts, appleCredsPresent, importGoogleContacts, downloadContactsDataLocally} from '/odd.js';
      window.addContact = addContact;
      window.getContacts = getContacts;
      window.editContact = editContact;
      window.deleteContact = deleteContact;
      window.filterContacts = filterContacts;
      window.updateProfile = updateProfile;
      window.signout = signout;
      window.generateRecoveryKit = generateRecoveryKit;
      window.importContacts = importContacts;
      window.importGoogleContacts = importGoogleContacts;
      window.downloadContactsDataLocally = downloadContactsDataLocally;
      window.getProfile = getProfile;
      window.getContactByUID = getContactByUID;
      window.addConnection = addConnection;
      window.getContactForRelate = getContactForRelate;
      window.addConnection = addConnection;
      window.appleCredsPresent = appleCredsPresent;

      var session = await account.activeSession();
      if (session == false) {
        window.location.href = '/home';
      }

      window.refreshContacts = function(){
        window.getContacts().then((result) => {
          document.querySelector("contact-table").contacts = result
        })
      }
      refreshContacts();
      
      window.refreshProfile = function(){
        window.getProfile().then((result) => {
        console.log("result: ", result)
        document.getElementById("big_handle").innerHTML = result.handle
        document.getElementById("big_name").innerHTML = "Name: " + result.name
        document.getElementById("big_tags").innerHTML = '';

        document.getElementById("small_handle").innerHTML = result.handle
        document.getElementById("small_name").innerHTML = "Name: " + result.name
        document.getElementById("small_tags").innerHTML = '';


        for (let tag of result.tags) {
          if (tag == '') continue;
          document.getElementById("big_tags").innerHTML += `<span class="badge badge-neutral">${tag}</span>`;
          document.getElementById("small_tags").innerHTML += `<span class="badge badge-neutral">${tag}</span>`;
        }

        document.getElementById("profile-name").value = result.name
        document.getElementById("profile-tags").value = result.tags || []
        document.getElementById("profile-text").value = result.text || ''
        document.getElementById("big_screen_avatar").innerHTML = result.handle.charAt(0).toUpperCase()
        
        
        document.getElementById("small_screen_avatar").innerHTML = result.handle.charAt(0).toUpperCase()

      })}
      refreshProfile();

      



      window.portOldContacts = portOldContacts

      var agentHandle = await shovel.agent.handle()

      // TODO - fix channel - "(broker-handle)-(approver-handle)-relationship"
      // TODO - dial broker address 
      const approver = await shovel.agent.actAsRelationshipApprover("<%= address %>", "<%= broker %>", `${agentHandle}`)
  
      shovel.agent.approver.notification.addEventListener("challengeRecieved", async (challengeEvent) => {
        console.log(challengeEvent.detail)
        await addConnection(challengeEvent.detail.message.challenge.person)

        let self = await getContactForRelate()
        console.log("Person with XML :", self)
        // TODO Implementing auto-confim - check challenge to implement reject
        await challengeEvent.detail.confirm({person: self})
      })
    </script>

    <div class="container mx-auto px-4 h-screen flex flex-col justify-evenly items-center">
      <div class="w-full h-5/6 text-center flex flex-row justify-evenly">
        <div class="block md:hidden pl-4 pt-3">
          <div class="drawer">
            <input id="my-drawer" type="checkbox" class="drawer-toggle" />
            <div class="drawer-content">
              <!-- Page content here -->
              <label for="my-drawer" class="btn btn-ghost drawer-button">
                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="33" height="33" viewBox="0 0 50 50">
                  <path d="M 3 8 A 2.0002 2.0002 0 1 0 3 12 L 47 12 A 2.0002 2.0002 0 1 0 47 8 L 3 8 z M 3 23 A 2.0002 2.0002 0 1 0 3 27 L 47 27 A 2.0002 2.0002 0 1 0 47 23 L 3 23 z M 3 38 A 2.0002 2.0002 0 1 0 3 42 L 47 42 A 2.0002 2.0002 0 1 0 47 38 L 3 38 z"></path>
                  </svg>
              </label>
            </div> 
            <div class="drawer-side z-10">
              <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
              <ul class="menu p-4 w-80 min-h-full bg-base-200 text-base-content">
                <!-- Sidebar content here -->
                
                  <div class="flex justify-center items-center avatar online placeholder mx-20">
                     <div class="bg-neutral-focus text-neutral-content rounded-full w-32">
                      <span id="small_screen_avatar" class="text-3xl"></span>
                    </div>
                  </div>
                  <div class="text-xl pb-1 text-gray-700 font-light tracking-tight leading-none flex justify-center items-center px-2">Welcome <span id="small_handle" class="text-xl font-semibold px-2"></span></div>
                  <div id="small_name" class="text-xl font-bold tracking-tight leading-none flex justify-center items-center" ></div>
                  <div id="small_tags" class="space-x-1 space-y-1 pb-6"></div>

                <li><a class="flex justify-center">
                  <div id="network-btn" class="inline-flex items-center" onclick="network_modal.showModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-globe-central-south-asia" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0M4.882 1.731a.48.48 0 0 0 .14.291.487.487 0 0 1-.126.78l-.291.146a.7.7 0 0 0-.188.135l-.48.48a1 1 0 0 1-1.023.242l-.02-.007a1 1 0 0 0-.462-.04 7 7 0 0 1 2.45-2.027m-3 9.674.86-.216a1 1 0 0 0 .758-.97v-.184a1 1 0 0 1 .445-.832l.04-.026a1 1 0 0 0 .152-1.54L3.121 6.621a.414.414 0 0 1 .542-.624l1.09.818a.5.5 0 0 0 .523.047.5.5 0 0 1 .724.447v.455a.8.8 0 0 0 .131.433l.795 1.192a1 1 0 0 1 .116.238l.73 2.19a1 1 0 0 0 .949.683h.058a1 1 0 0 0 .949-.684l.73-2.189a1 1 0 0 1 .116-.238l.791-1.187A.45.45 0 0 1 11.743 8c.16 0 .306.084.392.218.557.875 1.63 2.282 2.365 2.282l.04-.001a7.003 7.003 0 0 1-12.658.905Z"/></svg>
                    <span class="ml-2 text-xl">Network</span>
                  </div>
                </a></li>
                  
                <li><a class="flex justify-center">
                  <div id="profile-edit-btn" class="inline-flex items-center" onclick="profile_edit_modal.showModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16"> <path fill="currentColor" d="m13.498.795l.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001zm-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057l3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708l-1.585-1.585z" /></svg>
                    <span class="ml-2 text-xl">Edit Profile</span>
                  </div>
                </a></li>

                <li><a class="flex justify-center">
                  <div id="apple-import" class="inline-flex items-center" onclick="onAppleImportClick()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16"><defs><path id="biApple0" d="M11.182.008C11.148-.03 9.923.023 8.857 1.18c-1.066 1.156-.902 2.482-.878 2.516c.024.034 1.52.087 2.475-1.258c.955-1.345.762-2.391.728-2.43Zm3.314 11.733c-.048-.096-2.325-1.234-2.113-3.422c.212-2.189 1.675-2.789 1.698-2.854c.023-.065-.597-.79-1.254-1.157a3.692 3.692 0 0 0-1.563-.434c-.108-.003-.483-.095-1.254.116c-.508.139-1.653.589-1.968.607c-.316.018-1.256-.522-2.267-.665c-.647-.125-1.333.131-1.824.328c-.49.196-1.422.754-2.074 2.237c-.652 1.482-.311 3.83-.067 4.56c.244.729.625 1.924 1.273 2.796c.576.984 1.34 1.667 1.659 1.899c.319.232 1.219.386 1.843.067c.502-.308 1.408-.485 1.766-.472c.357.013 1.061.154 1.782.539c.571.197 1.111.115 1.652-.105c.541-.221 1.324-1.059 2.238-2.758c.347-.79.505-1.217.473-1.282Z"/></defs><g fill="currentColor"><use href="#biApple0"/><use href="#biApple0"/></g></svg>
                    <span class="ml-2 text-xl">Import</span>
                  </div>
                </a></li>

                <li><a class="flex justify-center">
                  <div id="google-import" class="inline-flex items-center" onclick="importGoogleContacts(refreshContacts)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16"><path fill="currentColor" d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.792 4.792 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301c1.078 0 2.004-.276 2.722-.764h-.003a3.702 3.702 0 0 0 1.599-2.431H8v-3.08h7.545z"/></svg>
                    <span class="ml-2 text-xl">Import</span>
                  </div>
                </a></li>
                
                <li><a class="flex justify-center">
                  <div class="inline-flex items-center" onclick="generateRecoveryKit(document.getElementById('handle').innerHTML)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16"><g fill="currentColor"><path d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 10h-.535A4 4 0 0 1 0 8zm4-3a3 3 0 1 0 2.712 4.285A.5.5 0 0 1 7.163 9h.63l.853-.854a.5.5 0 0 1 .708 0l.646.647l.646-.647a.5.5 0 0 1 .708 0l.646.647l.646-.647a.5.5 0 0 1 .708 0l.646.647l.793-.793l-1-1h-6.63a.5.5 0 0 1-.451-.285A3 3 0 0 0 4 5z" /><path d="M4 8a1 1 0 1 1-2 0a1 1 0 0 1 2 0z" /></g></svg>
                    <span class="ml-2 text-xl">Recovery Key</span>
                  </div>
                </a></li>

                <li><a class="flex justify-center">
                  <div class="inline-flex items-center" onclick="generateRecoveryKit(document.getElementById('handle').innerHTML)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16"><g fill="currentColor"><path d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 10h-.535A4 4 0 0 1 0 8zm4-3a3 3 0 1 0 2.712 4.285A.5.5 0 0 1 7.163 9h.63l.853-.854a.5.5 0 0 1 .708 0l.646.647l.646-.647a.5.5 0 0 1 .708 0l.646.647l.646-.647a.5.5 0 0 1 .708 0l.646.647l.793-.793l-1-1h-6.63a.5.5 0 0 1-.451-.285A3 3 0 0 0 4 5z" /><path d="M4 8a1 1 0 1 1-2 0a1 1 0 0 1 2 0z" /></g></svg>
                    <span class="ml-2 text-xl">Recovery Key</span>
                  </div>
                </a></li>

                <li><a class="flex justify-center">
                  <div class="inline-flex items-center" onclick="downloadContactsDataLocally()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16"><g fill="currentColor"><path d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773C16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318C1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593c.143-.863.698-1.723 1.464-2.383z"/><path d="M7.646 15.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 14.293V5.5a.5.5 0 0 0-1 0v8.793l-2.146-2.147a.5.5 0 0 0-.708.708l3 3z"/></g></svg>
                    <span class="ml-2 text-xl">Export Data</span>
                  </div>
                </a></li>

                <li><a class="flex justify-center">
                  <div class="inline-flex items-center" onclick="logout_modal.showModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16"><path fill="currentColor" d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2zM3 8a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1H3z" /></svg>
                    <span class="ml-2 text-xl">Logout</span>
                  </div>
                </a></li>
                
              </ul>
            </div>
          </div>
        </div>
        <div class="relative bg-base-200 w-1/4 py-4 space-y-2 rounded-lg hidden md:block">
          <%- include('../partials/app/sidebar.ejs') %>
        </div>
        
        <div class="w-3/4 py-4 space-y-2 overflow-hidden">
          <div class="flex justify-evenly">
            <%- include('../partials/app/search_bar.ejs') %>
            <%- include('../partials/app/contact_add.ejs') %>
          </div>
          <div class="flex flex-col justify-center max-h-full py-4 overflow-y-auto relative">
            <%- include('../partials/app/contact_list.ejs') %>
          </div>
        </div>
      </div>
      <%- include('../partials/shovel.ejs') %>
    </div>
  </body>

</html>
